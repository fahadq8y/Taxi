<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§ÙƒØ³ÙŠ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            direction: rtl;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .driver-profile {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            color: white;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .profile-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-card {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 10px;
            border-right: 4px solid #2563eb;
        }

        .info-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .info-label {
            color: #6b7280;
        }

        .info-value {
            font-weight: 600;
            color: #1f2937;
        }

        .maintenance-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .maintenance-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            direction: rtl;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .update-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .update-btn:hover {
            transform: translateY(-2px);
        }

        .notifications-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            transition: background 0.3s;
        }

        .notification-item:hover {
            background: #f9fafb;
        }

        .notification-unread {
            background: #eff6ff;
            border-right: 4px solid #2563eb;
        }

        .notification-read {
            background: #f9fafb;
            border-right: 4px solid #d1d5db;
        }

        .notification-icon {
            font-size: 1.5rem;
            margin-top: 0.25rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .notification-message {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .mark-read-btn {
            background: none;
            border: none;
            color: #2563eb;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: underline;
        }

        .alerts-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 10px;
        }

        .alert-urgent {
            background: #fef2f2;
            border-right: 4px solid #dc2626;
        }

        .alert-warning {
            background: #fffbeb;
            border-right: 4px solid #f59e0b;
        }

        .alert-info {
            background: #eff6ff;
            border-right: 4px solid #2563eb;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-desc {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .maintenance-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš• ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
        <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <div id="driverContent" style="display: none;">
            <!-- Ù…Ù„Ù Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø´Ø®ØµÙŠ -->
            <div class="driver-profile">
                <div class="profile-header">
                    <div class="profile-avatar">ğŸ‘¨â€ğŸ’¼</div>
                    <div class="profile-name" id="driverName">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
                    <div class="profile-status" id="driverStatus">Ù†Ø´Ø·</div>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-title">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
                        <div class="info-item">
                            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                            <span class="info-value" id="driverPhone">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:</span>
                            <span class="info-value" id="nationalId">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:</span>
                            <span class="info-value" id="dailyRent">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</div>
                        <div class="info-item">
                            <span class="info-label">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯:</span>
                            <span class="info-value" id="contractStart">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯:</span>
                            <span class="info-value" id="contractEnd">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©:</span>
                            <span class="info-value" id="assignedCar">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-title">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>
                        <div class="info-item">
                            <span class="info-label">Ø¢Ø®Ø± Ø¯ÙØ¹Ø©:</span>
                            <span class="info-value" id="lastPayment">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±:</span>
                            <span class="info-value" id="delayDays">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±:</span>
                            <span class="info-value" id="delayAmount">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-title">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                        <div class="info-item">
                            <span class="info-label">Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ø±ÙˆØ±ÙŠØ©:</span>
                            <span class="info-value" id="trafficViolations">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©:</span>
                            <span class="info-value" id="residenceExpenses">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª:</span>
                            <span class="info-value" id="totalVariables">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
            <div class="maintenance-section">
                <div class="section-title">
                    ğŸ”§ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©
                </div>
                
                <form id="maintenanceForm" class="maintenance-form">
                    <div class="form-group">
                        <label for="lastOilChange">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØºÙŠÙŠØ± Ø²ÙŠØª</label>
                        <input type="date" id="lastOilChange">
                    </div>
                    <div class="form-group">
                        <label for="currentKilometers">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
                        <input type="number" id="currentKilometers" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª">
                    </div>
                </form>
                
                <button type="button" class="update-btn" onclick="updateMaintenance()">
                    ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©
                </button>
            </div>

            <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
            <div class="notifications-section">
                <div class="section-title">
                    ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                </div>
                <div id="notificationsList">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ -->
                </div>
            </div>

            <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
            <div class="alerts-section">
                <div class="section-title">
                    âš ï¸ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
                </div>
                <div id="alertsList">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‡Ù†Ø§ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentDriver = null;
        let currentDriverId = null;

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (!user || localStorage.getItem('userRole') !== 'driver') {
                window.location.href = 'index.html';
                return;
            }
            
            currentDriverId = localStorage.getItem('userId');
            loadDriverData();
        });

        // Load driver data
        async function loadDriverData() {
            try {
                // Get driver data
                const driverDoc = await getDoc(doc(db, 'drivers', currentDriverId));
                
                if (!driverDoc.exists()) {
                    throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                }

                currentDriver = { id: driverDoc.id, ...driverDoc.data() };
                
                await Promise.all([
                    displayDriverInfo(),
                    loadNotifications(),
                    loadAlerts()
                ]);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('driverContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading driver data:', error);
                document.getElementById('loading').innerHTML = '<p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            }
        }

        // Display driver information
        async function displayDriverInfo() {
            const driver = currentDriver;

            // Basic info
            document.getElementById('driverName').textContent = driver.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('driverPhone').textContent = driver.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('nationalId').textContent = driver.nationalId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('dailyRent').textContent = `${driver.dailyRent || 0} Ø¯.Ùƒ`;

            // Status
            const statusElement = document.getElementById('driverStatus');
            statusElement.textContent = driver.contractStatus === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
            statusElement.className = `profile-status ${driver.contractStatus === 'active' ? 'status-active' : 'status-inactive'}`;

            // Contract info
            if (driver.contractStartDate) {
                document.getElementById('contractStart').textContent = new Date(driver.contractStartDate.seconds * 1000).toLocaleDateString('ar');
            }
            if (driver.contractEndDate) {
                document.getElementById('contractEnd').textContent = new Date(driver.contractEndDate.seconds * 1000).toLocaleDateString('ar');
            }

            // Get assigned car info
            if (driver.assignedCarId) {
                try {
                    const carDoc = await getDoc(doc(db, 'cars', driver.assignedCarId));
                    if (carDoc.exists()) {
                        const car = carDoc.data();
                        document.getElementById('assignedCar').textContent = `${car.plateNumber} - ${car.brand} ${car.model}`;
                    }
                } catch (error) {
                    console.error('Error loading car data:', error);
                }
            }

            // Payment info
            if (driver.lastPaymentDate) {
                document.getElementById('lastPayment').textContent = new Date(driver.lastPaymentDate.seconds * 1000).toLocaleDateString('ar');
            }
            document.getElementById('delayDays').textContent = `${driver.delayDays || 0} ÙŠÙˆÙ…`;
            document.getElementById('delayAmount').textContent = `${driver.delayAmount || 0} Ø¯.Ùƒ`;

            // Expenses
            document.getElementById('trafficViolations').textContent = `${driver.trafficViolations || 0} Ø¯.Ùƒ`;
            document.getElementById('residenceExpenses').textContent = `${driver.residenceExpenses || 0} Ø¯.Ùƒ`;
            document.getElementById('totalVariables').textContent = `${driver.totalVariables || 0} Ø¯.Ùƒ`;

            // Maintenance info
            if (driver.lastOilChangeDate) {
                document.getElementById('lastOilChange').value = new Date(driver.lastOilChangeDate.seconds * 1000).toISOString().split('T')[0];
            }
            document.getElementById('currentKilometers').value = driver.currentKilometers || '';
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const notificationsQuery = query(
                    collection(db, 'notifications'),
                    where('recipientId', '==', currentDriverId),
                    orderBy('createdAt', 'desc')
                );
                
                const notificationsSnapshot = await getDocs(notificationsQuery);
                const notifications = [];
                
                notificationsSnapshot.forEach(doc => {
                    notifications.push({ id: doc.id, ...doc.data() });
                });

                displayNotifications(notifications);

            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Display notifications
        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');

            if (notifications.length === 0) {
                notificationsList.innerHTML = '<div class="notification-item"><div class="notification-content"><div class="notification-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div></div></div>';
                return;
            }

            notificationsList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.isRead ? 'notification-read' : 'notification-unread'}">
                    <div class="notification-icon">
                        ${notification.type === 'custom' ? 'ğŸ“¢' : 
                          notification.type === 'document_expiry' ? 'ğŸ“„' : 
                          notification.type === 'oil_change' ? 'ğŸ”§' : 'ğŸ’°'}
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-meta">
                            <span>Ù…Ù†: ${notification.senderName}</span>
                            <span>${new Date(notification.createdAt.seconds * 1000).toLocaleDateString('ar')}</span>
                            ${!notification.isRead ? `<button class="mark-read-btn" onclick="markAsRead('${notification.id}')">ØªÙ…ÙŠÙŠØ² ÙƒÙ…Ù‚Ø±ÙˆØ¡</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Load alerts
        function loadAlerts() {
            const alerts = [];
            const today = new Date();
            const driver = currentDriver;

            // Check document expiry alerts
            const documents = [
                { field: 'carRegistrationExpiry', name: 'Ø¯ÙØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©', warningDays: 30 },
                { field: 'residenceExpiry', name: 'Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©', warningDays: 30 },
                { field: 'licenseExpiry', name: 'Ø§Ù„Ø±Ø®ØµØ©', warningDays: 30 },
                { field: 'permitExpiry', name: 'Ø§Ù„ØªØµØ±ÙŠØ­', warningDays: 30 },
                { field: 'passportExpiry', name: 'Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±', warningDays: 425 }
            ];

            documents.forEach(docType => {
                if (driver[docType.field]) {
                    const expiryDate = driver[docType.field].toDate();
                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                    if (daysUntilExpiry <= 0) {
                        alerts.push({
                            type: 'urgent',
                            icon: 'âš ï¸',
                            title: `Ø§Ù†ØªÙ‡Ù‰ ${docType.name}`,
                            desc: `Ø§Ù†ØªÙ‡Ù‰ Ù…Ù†Ø° ${Math.abs(daysUntilExpiry)} ÙŠÙˆÙ…`
                        });
                    } else if (daysUntilExpiry <= docType.warningDays) {
                        alerts.push({
                            type: 'warning',
                            icon: 'ğŸ“„',
                            title: `${docType.name} ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹`,
                            desc: `ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${daysUntilExpiry} ÙŠÙˆÙ…`
                        });
                    }
                }
            });

            // Check oil change alert
            if (driver.lastOilChangeDate) {
                const lastOilChange = driver.lastOilChangeDate.toDate();
                const daysSinceOilChange = Math.ceil((today - lastOilChange) / (1000 * 60 * 60 * 24));

                if (daysSinceOilChange >= 15) {
                    alerts.push({
                        type: 'warning',
                        icon: 'ğŸ”§',
                        title: 'ØªØºÙŠÙŠØ± Ø²ÙŠØª Ø§Ù„Ù…ÙƒÙŠÙ†Ø©',
                        desc: `Ù…Ø± ${daysSinceOilChange} ÙŠÙˆÙ… Ù…Ù†Ø° Ø¢Ø®Ø± ØªØºÙŠÙŠØ±`
                    });
                }
            }

            displayAlerts(alerts);
        }

        // Display alerts
        function displayAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');

            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="alert-item alert-info"><div class="alert-icon">âœ…</div><div class="alert-content"><div class="alert-title">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div><div class="alert-desc">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…ÙˆØ± ØªØ³ÙŠØ± Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ</div></div></div>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.type}">
                    <div class="alert-icon">${alert.icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-desc">${alert.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        // Update maintenance information
        window.updateMaintenance = async () => {
            const lastOilChange = document.getElementById('lastOilChange').value;
            const currentKilometers = document.getElementById('currentKilometers').value;

            if (!lastOilChange && !currentKilometers) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® ØªØºÙŠÙŠØ± Ø§Ù„Ø²ÙŠØª Ø£Ùˆ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª');
                return;
            }

            try {
                const updateData = {
                    updatedAt: new Date()
                };

                if (lastOilChange) {
                    updateData.lastOilChangeDate = new Date(lastOilChange);
                }

                if (currentKilometers) {
                    updateData.currentKilometers = parseInt(currentKilometers);
                }

                await updateDoc(doc(db, 'drivers', currentDriverId), updateData);
                
                // Update current driver data
                Object.assign(currentDriver, updateData);
                
                // Reload alerts to reflect changes
                loadAlerts();
                
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­');

            } catch (error) {
                console.error('Error updating maintenance:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        };

        // Mark notification as read
        window.markAsRead = async (notificationId) => {
            try {
                await updateDoc(doc(db, 'notifications', notificationId), {
                    isRead: true
                });
                
                // Reload notifications
                await loadNotifications();

            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        };

        // Logout function
        window.logout = async () => {
            try {
                await signOut(auth);
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
    </script>
</body>
</html>

