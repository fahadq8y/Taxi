<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ¶ŸÇ - ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿßŸÉÿ≥Ÿä</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            direction: rtl;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .driver-profile {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            color: white;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .profile-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-card {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 10px;
            border-right: 4px solid #2563eb;
        }

        .info-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .info-label {
            color: #6b7280;
        }

        .info-value {
            font-weight: 600;
            color: #1f2937;
        }

        .maintenance-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .maintenance-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            direction: rtl;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .update-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .update-btn:hover {
            transform: translateY(-2px);
        }

        .notifications-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            transition: background 0.3s;
        }

        .notification-item:hover {
            background: #f9fafb;
        }

        .notification-unread {
            background: #eff6ff;
            border-right: 4px solid #2563eb;
        }

        .notification-read {
            background: #f9fafb;
            border-right: 4px solid #d1d5db;
        }

        .notification-icon {
            font-size: 1.5rem;
            margin-top: 0.25rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .notification-message {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .mark-read-btn {
            background: none;
            border: none;
            color: #2563eb;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: underline;
        }

        .alerts-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 10px;
        }

        .alert-urgent {
            background: #fef2f2;
            border-right: 4px solid #dc2626;
        }

        .alert-warning {
            background: #fffbeb;
            border-right: 4px solid #f59e0b;
        }

        .alert-info {
            background: #eff6ff;
            border-right: 4px solid #2563eb;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-desc {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .maintenance-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöï ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ¶ŸÇ</h1>
        <button class="logout-btn" onclick="logout()">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
    </div>

    <div class="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</p>
        </div>

        <div id="driverContent" style="display: none;">
            <!-- ŸÖŸÑŸÅ ÿßŸÑÿ≥ÿßÿ¶ŸÇ ÿßŸÑÿ¥ÿÆÿµŸä -->
            <div class="driver-profile">
                <div class="profile-header">
                    <div class="profile-avatar">üë®‚Äçüíº</div>
                    <div class="profile-name" id="driverName">ÿßÿ≥ŸÖ ÿßŸÑÿ≥ÿßÿ¶ŸÇ</div>
                    <div class="profile-status" id="driverStatus">ŸÜÿ¥ÿ∑</div>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-title">ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©</div>
                        <div class="info-item">
                            <span class="info-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:</span>
                            <span class="info-value" id="driverPhone">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ÿ±ŸÇŸÖ ÿßŸÑŸáŸàŸäÿ©:</span>
                            <span class="info-value" id="nationalId">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ÿßŸÑÿ£ÿ¨ÿ±ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©:</span>
                            <span class="info-value" id="dailyRent">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-title">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÇÿØ</div>
                        <div class="info-item">
                            <span class="info-label">ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿπŸÇÿØ:</span>
                            <span class="info-value" id="contractStart">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿπŸÇÿØ:</span>
                            <span class="info-value" id="contractEnd">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ÿßŸÑÿ≥Ÿäÿßÿ±ÿ© ÿßŸÑŸÖÿ§ÿ¨ÿ±ÿ©:</span>
                            <span class="info-value" id="assignedCar">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-title">ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™</div>
                        <div class="info-item">
                            <span class="info-label">ÿ¢ÿÆÿ± ÿØŸÅÿπÿ©:</span>
                            <span class="info-value" id="lastPayment">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ÿ£ŸäÿßŸÖ ÿßŸÑÿ™ÿ£ÿÆŸäÿ±:</span>
                            <span class="info-value" id="delayDays">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ŸÇŸäŸÖÿ© ÿßŸÑÿ™ÿ£ÿÆŸäÿ±:</span>
                            <span class="info-value" id="delayAmount">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-title">ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ</div>
                        <div class="info-item">
                            <span class="info-label">ŸÖÿÆÿßŸÑŸÅÿßÿ™ ŸÖÿ±Ÿàÿ±Ÿäÿ©:</span>
                            <span class="info-value" id="trafficViolations">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿ•ŸÇÿßŸÖÿ©:</span>
                            <span class="info-value" id="residenceExpenses">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™:</span>
                            <span class="info-value" id="totalVariables">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ŸÇÿ≥ŸÖ ÿµŸäÿßŸÜÿ© ÿßŸÑÿ≥Ÿäÿßÿ±ÿ© -->
            <div class="maintenance-section">
                <div class="section-title">
                    üîß ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿµŸäÿßŸÜÿ© ÿßŸÑÿ≥Ÿäÿßÿ±ÿ©
                </div>
                
                <form id="maintenanceForm" class="maintenance-form">
                    <div class="form-group">
                        <label for="lastOilChange">ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ÿ™ÿ∫ŸäŸäÿ± ÿ≤Ÿäÿ™</label>
                        <input type="date" id="lastOilChange">
                    </div>
                    <div class="form-group">
                        <label for="currentKilometers">ÿπÿØÿØ ÿßŸÑŸÉŸäŸÑŸàŸÖÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸä</label>
                        <input type="number" id="currentKilometers" placeholder="ÿ£ÿØÿÆŸÑ ÿπÿØÿØ ÿßŸÑŸÉŸäŸÑŸàŸÖÿ™ÿ±ÿßÿ™">
                    </div>
                </form>
                
                <button type="button" class="update-btn" onclick="updateMaintenance()">
                    ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
                </button>
            </div>

            <!-- ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ -->
            <div class="notifications-section">
                <div class="section-title">
                    üîî ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
                </div>
                <div id="notificationsList">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸáŸÜÿß -->
                </div>
            </div>

            <!-- ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ -->
            <div class="alerts-section">
                <div class="section-title">
                    ‚ö†Ô∏è ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ ŸàÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™
                </div>
                <div id="alertsList">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ ŸáŸÜÿß -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentDriver = null;
        let currentDriverId = null;

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (!user || localStorage.getItem('userRole') !== 'driver') {
                window.location.href = 'index.html';
                return;
            }
            
            currentDriverId = localStorage.getItem('userId');
            loadDriverData();
        });

        // Load driver data
        async function loadDriverData() {
            try {
                // Get driver data
                const driverDoc = await getDoc(doc(db, 'drivers', currentDriverId));
                
                if (!driverDoc.exists()) {
                    throw new Error('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿßÿ¶ŸÇ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                }

                currentDriver = { id: driverDoc.id, ...driverDoc.data() };
                
                await Promise.all([
                    displayDriverInfo(),
                    loadNotifications(),
                    loadAlerts()
                ]);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('driverContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading driver data:', error);
                document.getElementById('loading').innerHTML = '<p>ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</p>';
            }
        }

        // Display driver information
        async function displayDriverInfo() {
            const driver = currentDriver;

            // Basic info
            document.getElementById('driverName').textContent = driver.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            document.getElementById('driverPhone').textContent = driver.phone || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            document.getElementById('nationalId').textContent = driver.nationalId || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            document.getElementById('dailyRent').textContent = `${driver.dailyRent || 0} ÿØ.ŸÉ`;

            // Status
            const statusElement = document.getElementById('driverStatus');
            statusElement.textContent = driver.contractStatus === 'active' ? 'ŸÜÿ¥ÿ∑' : 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑';
            statusElement.className = `profile-status ${driver.contractStatus === 'active' ? 'status-active' : 'status-inactive'}`;

            // Contract info
            if (driver.contractStartDate) {
                document.getElementById('contractStart').textContent = new Date(driver.contractStartDate.seconds * 1000).toLocaleDateString('ar');
            }
            if (driver.contractEndDate) {
                document.getElementById('contractEnd').textContent = new Date(driver.contractEndDate.seconds * 1000).toLocaleDateString('ar');
            }

            // Get assigned car info
            if (driver.assignedCarId) {
                try {
                    const carDoc = await getDoc(doc(db, 'cars', driver.assignedCarId));
                    if (carDoc.exists()) {
                        const car = carDoc.data();
                        document.getElementById('assignedCar').textContent = `${car.plateNumber} - ${car.brand} ${car.model}`;
                    }
                } catch (error) {
                    console.error('Error loading car data:', error);
                }
            }

            // Payment info
            if (driver.lastPaymentDate) {
                document.getElementById('lastPayment').textContent = new Date(driver.lastPaymentDate.seconds * 1000).toLocaleDateString('ar');
            }
            document.getElementById('delayDays').textContent = `${driver.delayDays || 0} ŸäŸàŸÖ`;
            document.getElementById('delayAmount').textContent = `${driver.delayAmount || 0} ÿØ.ŸÉ`;

            // Expenses
            document.getElementById('trafficViolations').textContent = `${driver.trafficViolations || 0} ÿØ.ŸÉ`;
            document.getElementById('residenceExpenses').textContent = `${driver.residenceExpenses || 0} ÿØ.ŸÉ`;
            document.getElementById('totalVariables').textContent = `${driver.totalVariables || 0} ÿØ.ŸÉ`;

            // Maintenance info
            if (driver.lastOilChangeDate) {
                document.getElementById('lastOilChange').value = new Date(driver.lastOilChangeDate.seconds * 1000).toISOString().split('T')[0];
            }
            document.getElementById('currentKilometers').value = driver.currentKilometers || '';
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const notificationsQuery = query(
                    collection(db, 'notifications'),
                    where('recipientId', '==', currentDriverId),
                    orderBy('createdAt', 'desc')
                );
                
                const notificationsSnapshot = await getDocs(notificationsQuery);
                const notifications = [];
                
                notificationsSnapshot.forEach(doc => {
                    notifications.push({ id: doc.id, ...doc.data() });
                });

                displayNotifications(notifications);

            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Display notifications
        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');

            if (notifications.length === 0) {
                notificationsList.innerHTML = '<div class="notification-item"><div class="notification-content"><div class="notification-title">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</div></div></div>';
                return;
            }

            notificationsList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.isRead ? 'notification-read' : 'notification-unread'}">
                    <div class="notification-icon">
                        ${notification.type === 'custom' ? 'üì¢' : 
                          notification.type === 'document_expiry' ? 'üìÑ' : 
                          notification.type === 'oil_change' ? 'üîß' : 'üí∞'}
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-meta">
                            <span>ŸÖŸÜ: ${notification.senderName}</span>
                            <span>${new Date(notification.createdAt.seconds * 1000).toLocaleDateString('ar')}</span>
                            ${!notification.isRead ? `<button class="mark-read-btn" onclick="markAsRead('${notification.id}')">ÿ™ŸÖŸäŸäÿ≤ ŸÉŸÖŸÇÿ±Ÿàÿ°</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Load alerts
        function loadAlerts() {
            const alerts = [];
            const today = new Date();
            const driver = currentDriver;

            // Check document expiry alerts
            const documents = [
                { field: 'carRegistrationExpiry', name: 'ÿØŸÅÿ™ÿ± ÿßŸÑÿ≥Ÿäÿßÿ±ÿ©', warningDays: 30 },
                { field: 'residenceExpiry', name: 'ÿßŸÑÿ•ŸÇÿßŸÖÿ©', warningDays: 30 },
                { field: 'licenseExpiry', name: 'ÿßŸÑÿ±ÿÆÿµÿ©', warningDays: 30 },
                { field: 'permitExpiry', name: 'ÿßŸÑÿ™ÿµÿ±Ÿäÿ≠', warningDays: 30 },
                { field: 'passportExpiry', name: 'ÿ¨Ÿàÿßÿ≤ ÿßŸÑÿ≥ŸÅÿ±', warningDays: 425 }
            ];

            documents.forEach(docType => {
                if (driver[docType.field]) {
                    const expiryDate = driver[docType.field].toDate();
                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                    if (daysUntilExpiry <= 0) {
                        alerts.push({
                            type: 'urgent',
                            icon: '‚ö†Ô∏è',
                            title: `ÿßŸÜÿ™ŸáŸâ ${docType.name}`,
                            desc: `ÿßŸÜÿ™ŸáŸâ ŸÖŸÜÿ∞ ${Math.abs(daysUntilExpiry)} ŸäŸàŸÖ`
                        });
                    } else if (daysUntilExpiry <= docType.warningDays) {
                        alerts.push({
                            type: 'warning',
                            icon: 'üìÑ',
                            title: `${docType.name} ŸäŸÜÿ™ŸáŸä ŸÇÿ±Ÿäÿ®ÿßŸã`,
                            desc: `ŸäŸÜÿ™ŸáŸä ÿÆŸÑÿßŸÑ ${daysUntilExpiry} ŸäŸàŸÖ`
                        });
                    }
                }
            });

            // Check oil change alert
            if (driver.lastOilChangeDate) {
                const lastOilChange = driver.lastOilChangeDate.toDate();
                const daysSinceOilChange = Math.ceil((today - lastOilChange) / (1000 * 60 * 60 * 24));

                if (daysSinceOilChange >= 15) {
                    alerts.push({
                        type: 'warning',
                        icon: 'üîß',
                        title: 'ÿ™ÿ∫ŸäŸäÿ± ÿ≤Ÿäÿ™ ÿßŸÑŸÖŸÉŸäŸÜÿ©',
                        desc: `ŸÖÿ± ${daysSinceOilChange} ŸäŸàŸÖ ŸÖŸÜÿ∞ ÿ¢ÿÆÿ± ÿ™ÿ∫ŸäŸäÿ±`
                    });
                }
            }

            displayAlerts(alerts);
        }

        // Display alerts
        function displayAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');

            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="alert-item alert-info"><div class="alert-icon">‚úÖ</div><div class="alert-content"><div class="alert-title">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÜÿ®ŸäŸáÿßÿ™</div><div class="alert-desc">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÖŸàÿ± ÿ™ÿ≥Ÿäÿ± ÿ®ÿ¥ŸÉŸÑ ÿ∑ÿ®ŸäÿπŸä</div></div></div>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.type}">
                    <div class="alert-icon">${alert.icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-desc">${alert.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        // Update maintenance information
        window.updateMaintenance = async () => {
            const lastOilChange = document.getElementById('lastOilChange').value;
            const currentKilometers = document.getElementById('currentKilometers').value;

            if (!lastOilChange && !currentKilometers) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ≤Ÿäÿ™ ÿ£Ÿà ÿπÿØÿØ ÿßŸÑŸÉŸäŸÑŸàŸÖÿ™ÿ±ÿßÿ™');
                return;
            }

            try {
                const updateData = {
                    updatedAt: new Date()
                };

                if (lastOilChange) {
                    updateData.lastOilChangeDate = new Date(lastOilChange);
                }

                if (currentKilometers) {
                    updateData.currentKilometers = parseInt(currentKilometers);
                }

                await updateDoc(doc(db, 'drivers', currentDriverId), updateData);
                
                // Update current driver data
                Object.assign(currentDriver, updateData);
                
                // Reload alerts to reflect changes
                loadAlerts();
                
                alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠');

            } catch (error) {
                console.error('Error updating maintenance:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        };

        // Mark notification as read
        window.markAsRead = async (notificationId) => {
            try {
                await updateDoc(doc(db, 'notifications', notificationId), {
                    isRead: true
                });
                
                // Reload notifications
                await loadNotifications();

            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        };

        // Logout function
        window.logout = async () => {
            try {
                await signOut(auth);
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
    </script>
</body>
</html>

