<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دفعات السائق - نظام إدارة التاكسي</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .driver-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .driver-info h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .driver-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: bold;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        .payments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .payment-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-top: 4px solid;
        }

        .payment-card.daily { border-top-color: #4CAF50; }
        .payment-card.old-debt { border-top-color: #2196F3; }
        .payment-card.violations { border-top-color: #FF9800; }
        .payment-card.residency { border-top-color: #9C27B0; }
        .payment-card.salary-fees { border-top-color: #607D8B; }

        .payment-card h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-payment {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-daily { background: #4CAF50; color: white; }
        .btn-old-debt { background: #2196F3; color: white; }
        .btn-violations { background: #FF9800; color: white; }
        .btn-residency { background: #9C27B0; color: white; }
        .btn-salary-fees { background: #607D8B; color: white; }

        .btn-payment:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .payment-history {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .payment-history h3 {
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .history-table th,
        .history-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .history-table tr:hover {
            background: #f5f5f5;
        }

        .amount-positive { color: #4CAF50; font-weight: bold; }
        .amount-negative { color: #f44336; font-weight: bold; }

        .error-message {
            background: #f44336;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: white;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .payments-grid {
                grid-template-columns: 1fr;
            }
            
            .driver-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>💰 دفعات السائق</h1>
        <div class="header-buttons">
            <a href="drivers-overview-fixed.html" class="btn btn-secondary">العودة لجدول السائقين</a>
        </div>
    </div>

    <div class="container">
        <div id="loadingMessage" class="loading">جاري تحميل بيانات السائق...</div>
        
        <div id="errorMessage" class="error-message" style="display: none;">
            <h3>خطأ في تحميل بيانات السائق</h3>
            <p id="errorText">السائق غير موجود</p>
            <a href="drivers-overview-fixed.html" class="btn btn-secondary" style="margin-top: 1rem;">العودة لجدول السائقين</a>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Driver Info -->
            <div class="driver-info">
                <h2 id="driverName">دفعات السائق</h2>
                <div class="driver-details">
                    <div class="detail-item">
                        <span class="detail-label">الأجرة اليومية:</span>
                        <span class="detail-value" id="dailyWage">0 د.ك</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">تاريخ بداية العقد:</span>
                        <span class="detail-value" id="contractStart">غير محدد</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">تاريخ آخر سداد:</span>
                        <span class="detail-value" id="lastPayment">غير محدد</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">المخالفات:</span>
                        <span class="detail-value amount-negative" id="violations">0 د.ك</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">مصاريف الإقامة:</span>
                        <span class="detail-value amount-negative" id="residencyFees">0 د.ك</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ديون قديمة:</span>
                        <span class="detail-value amount-negative" id="oldDebts">0 د.ك</span>
                    </div>
                </div>
            </div>

            <!-- Payment Forms -->
            <div class="payments-grid">
                <!-- Daily Payment -->
                <div class="payment-card daily">
                    <h3>💵 دفع التحصيل اليومي</h3>
                    <form id="dailyPaymentForm">
                        <div class="form-group">
                            <label>المبلغ (د.ك)</label>
                            <input type="number" step="0.001" id="dailyAmount" required>
                        </div>
                        <div class="form-group">
                            <label>التاريخ</label>
                            <input type="date" id="dailyDate" required>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="dailyNotes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-daily">إضافة دفعة يومية</button>
                    </form>
                </div>

                <!-- Old Debt Payment -->
                <div class="payment-card old-debt">
                    <h3>📋 دفع دين قديم</h3>
                    <form id="oldDebtForm">
                        <div class="form-group">
                            <label>المبلغ (د.ك)</label>
                            <input type="number" step="0.001" id="oldDebtAmount" required>
                        </div>
                        <div class="form-group">
                            <label>التاريخ</label>
                            <input type="date" id="oldDebtDate" required>
                        </div>
                        <div class="form-group">
                            <label>وصف الدين</label>
                            <textarea id="oldDebtDescription" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-old-debt">تسديد دين قديم</button>
                    </form>
                </div>

                <!-- Violations Management -->
                <div class="payment-card violations">
                    <h3>🚫 إدارة المخالفات</h3>
                    <div class="form-group">
                        <label>نوع العملية</label>
                        <select id="violationType" onchange="toggleViolationForm()">
                            <option value="">اختر نوع العملية</option>
                            <option value="pay">دفع مخالفة (الشركة تدفع)</option>
                            <option value="collect">تحصيل مخالفة (السائق يسدد)</option>
                        </select>
                    </div>
                    
                    <form id="violationPayForm" style="display: none;">
                        <div class="form-group">
                            <label>المبلغ (د.ك)</label>
                            <input type="number" step="0.001" id="violationPayAmount" required>
                        </div>
                        <div class="form-group">
                            <label>التاريخ</label>
                            <input type="date" id="violationPayDate" required>
                        </div>
                        <div class="form-group">
                            <label>وصف المخالفة</label>
                            <textarea id="violationDescription" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-violations">دفع مخالفة</button>
                    </form>

                    <form id="violationCollectForm" style="display: none;">
                        <div class="form-group">
                            <label>المبلغ (د.ك)</label>
                            <input type="number" step="0.001" id="violationCollectAmount" required>
                        </div>
                        <div class="form-group">
                            <label>التاريخ</label>
                            <input type="date" id="violationCollectDate" required>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="violationCollectNotes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-violations">تحصيل مخالفة</button>
                    </form>
                </div>

                <!-- Residency Management -->
                <div class="payment-card residency">
                    <h3>🏠 إدارة رسوم الإقامة</h3>
                    <div class="form-group">
                        <label>نوع العملية</label>
                        <select id="residencyType" onchange="toggleResidencyForm()">
                            <option value="">اختر نوع العملية</option>
                            <option value="pay">دفع رسوم إقامة (الشركة تدفع)</option>
                            <option value="collect">تحصيل رسوم إقامة (السائق يسدد)</option>
                        </select>
                    </div>
                    
                    <form id="residencyPayForm" style="display: none;">
                        <div class="form-group">
                            <label>المبلغ (د.ك)</label>
                            <input type="number" step="0.001" id="residencyPayAmount" required>
                        </div>
                        <div class="form-group">
                            <label>التاريخ</label>
                            <input type="date" id="residencyPayDate" required>
                        </div>
                        <div class="form-group">
                            <label>وصف الرسوم</label>
                            <textarea id="residencyDescription" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-residency">دفع رسوم إقامة</button>
                    </form>

                    <form id="residencyCollectForm" style="display: none;">
                        <div class="form-group">
                            <label>المبلغ (د.ك)</label>
                            <input type="number" step="0.001" id="residencyCollectAmount" required>
                        </div>
                        <div class="form-group">
                            <label>التاريخ</label>
                            <input type="date" id="residencyCollectDate" required>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="residencyCollectNotes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-residency">تحصيل رسوم إقامة</button>
                    </form>
                </div>

                <!-- Salary Fees Collection -->
                <div class="payment-card salary-fees">
                    <h3>💼 تحصيل رسوم الرواتب</h3>
                    <form id="salaryFeesForm">
                        <div class="form-group">
                            <label>المبلغ (د.ك)</label>
                            <input type="number" step="0.001" id="salaryFeesAmount" required>
                        </div>
                        <div class="form-group">
                            <label>التاريخ</label>
                            <input type="date" id="salaryFeesDate" required>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="salaryFeesNotes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-salary-fees">تحصيل رسوم رواتب</button>
                    </form>
                </div>
            </div>

            <!-- Payment History -->
            <div class="payment-history">
                <h3>📊 تاريخ الدفعات</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>نوع الدفعة</th>
                            <th>المبلغ</th>
                            <th>الوصف</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryBody">
                        <tr>
                            <td>18/06/2025</td>
                            <td>تحصيل أجرة يومية</td>
                            <td class="amount-positive">7.000 د.ك</td>
                            <td>دفعة يومية</td>
                            <td>إيراد</td>
                        </tr>
                        <tr>
                            <td>17/06/2025</td>
                            <td>مخالفة</td>
                            <td class="amount-negative">25.000 د.ك</td>
                            <td>مخالفة سرعة</td>
                            <td>دين على السائق</td>
                        </tr>
                        <tr>
                            <td>15/06/2025</td>
                            <td>رسوم إقامة</td>
                            <td class="amount-negative">50.000 د.ك</td>
                            <td>تجديد إقامة</td>
                            <td>دين على السائق</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, addDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration - نفس الإعدادات من صفحة إدارة السائقين
        const firebaseConfig = {
            apiKey: "AIzaSyB8Q9CYIWXPmTdiz3vPiLlPYFxiJu0vE_g",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.firebasestorage.app",
            messagingSenderId: "720874424166",
            appId: "1:720874424166:web:25f9c6d126e792b2e5eaa7",
            measurementId: "G-GY8820W410"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentDriver = null;

        // Load driver data
        async function loadDriverData() {
            try {
                // Get driver data from localStorage
                const driverData = localStorage.getItem('selectedDriver');
                if (!driverData) {
                    showError('لم يتم تحديد السائق');
                    return;
                }

                const driver = JSON.parse(driverData);
                console.log('Driver from localStorage:', driver);

                // Verify driver exists in Firebase
                const driverDoc = await getDoc(doc(db, 'drivers', driver.id));
                if (!driverDoc.exists()) {
                    showError('السائق غير موجود في قاعدة البيانات');
                    return;
                }

                currentDriver = { id: driver.id, ...driverDoc.data() };
                console.log('Driver from Firebase:', currentDriver);

                displayDriverInfo();
                setupForms();
                hideLoading();

            } catch (error) {
                console.error('Error loading driver:', error);
                showError('خطأ في تحميل بيانات السائق: ' + error.message);
            }
        }

        // Display driver information
        function displayDriverInfo() {
            document.getElementById('driverName').textContent = `دفعات السائق: ${currentDriver.name}`;
            document.getElementById('dailyWage').textContent = `${currentDriver.dailyWage || 0} د.ك`;
            document.getElementById('contractStart').textContent = formatDate(currentDriver.contractStartDate);
            document.getElementById('lastPayment').textContent = formatDate(currentDriver.lastPaymentDate);
            document.getElementById('violations').textContent = `${currentDriver.violations || 0} د.ك`;
            document.getElementById('residencyFees').textContent = `${currentDriver.residencyFees || 0} د.ك`;
            document.getElementById('oldDebts').textContent = `${currentDriver.oldDebts || 0} د.ك`;
        }

        // Setup form default values
        function setupForms() {
            const today = new Date().toISOString().split('T')[0];
            
            // Set today's date for all date inputs
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });

            // Set daily wage amount
            document.getElementById('dailyAmount').value = currentDriver.dailyWage || 0;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-SA');
            } catch {
                return dateString;
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // Toggle violation forms
        window.toggleViolationForm = function() {
            const type = document.getElementById('violationType').value;
            document.getElementById('violationPayForm').style.display = type === 'pay' ? 'block' : 'none';
            document.getElementById('violationCollectForm').style.display = type === 'collect' ? 'block' : 'none';
        }

        // Toggle residency forms
        window.toggleResidencyForm = function() {
            const type = document.getElementById('residencyType').value;
            document.getElementById('residencyPayForm').style.display = type === 'pay' ? 'block' : 'none';
            document.getElementById('residencyCollectForm').style.display = type === 'collect' ? 'block' : 'none';
        }

        // Form submission handlers
        document.getElementById('dailyPaymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('dailyAmount').value);
            const date = document.getElementById('dailyDate').value;
            const notes = document.getElementById('dailyNotes').value;

            await addPayment('daily_collection', amount, date, notes, 'revenue');
        });

        document.getElementById('oldDebtForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('oldDebtAmount').value);
            const date = document.getElementById('oldDebtDate').value;
            const description = document.getElementById('oldDebtDescription').value;

            await addPayment('old_debt', amount, date, description, 'revenue');
        });

        // Add payment function
        async function addPayment(type, amount, date, description, category) {
            try {
                // Add to revenues/expenses collection
                const paymentData = {
                    driverId: currentDriver.id,
                    driverName: currentDriver.name,
                    type: type,
                    amount: amount,
                    date: date,
                    description: description,
                    category: category,
                    createdAt: new Date().toISOString()
                };

                const collectionName = category === 'revenue' ? 'revenues' : 'expenses';
                await addDoc(collection(db, collectionName), paymentData);

                // Update driver data if needed
                if (type === 'daily_collection') {
                    await updateDoc(doc(db, 'drivers', currentDriver.id), {
                        lastPaymentDate: date,
                        paidUntilDate: date
                    });
                }

                alert('تم إضافة الدفعة بنجاح!');
                
                // Reload driver data
                await loadDriverData();

            } catch (error) {
                console.error('Error adding payment:', error);
                alert('خطأ في إضافة الدفعة: ' + error.message);
            }
        }

        // Load data on page load
        loadDriverData();
    </script>
</body>
</html>

