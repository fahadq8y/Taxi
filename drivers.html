<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة السائقين - نظام إدارة التاكسي</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>👥</text></svg>">
    
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="manifest" href="manifest.json?v=20250620">
    <meta name="theme-color" content="#667eea">
    <link rel="stylesheet" href="unified-design-system.css?v=20250620">
    
    <style>
        /* إضافة تنسيقات خاصة للنماذج المعقدة */
        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .section-title {
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #dee2e6;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            color: #495057;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
        }

        .save-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* إزالة الألوان الغريبة وتطبيق التصميم الموحد */
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        /* تحسين عرض البطاقات */
        .driver-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .driver-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .driver-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .driver-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .driver-phone {
            font-size: 1rem;
            opacity: 0.9;
        }

        .driver-body {
            padding: 1.5rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #666;
            font-size: 0.9rem;
        }

        .info-value {
            font-weight: 600;
            color: #333;
            text-align: left;
        }

        .driver-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f1f3f4;
        }

        .action-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .save-btn,
            .cancel-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>👥 إدارة السائقين</h1>
        <div class="header-buttons">
            <a href="index.html" class="btn btn-secondary">🏠 لوحة التحكم</a>
            <button class="btn btn-secondary" onclick="logout()">تسجيل الخروج</button>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <input type="text" class="search-input" id="searchInput" placeholder="البحث عن سائق..." onkeyup="filterDrivers()">
            <button class="add-btn" onclick="openAddModal()">إضافة سائق جديد</button>
        </div>

        <div class="cards-grid" id="driversGrid">
            <div class="loading">جاري تحميل السائقين...</div>
        </div>
    </div>

    <!-- نافذة إضافة سائق -->
    <div id="addDriverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">إضافة سائق جديد</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="driverForm">
                <!-- البيانات الشخصية -->
                <div class="form-section">
                    <h3 class="section-title">البيانات الشخصية</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="driverName">اسم السائق</label>
                            <input type="text" id="driverName" required>
                        </div>
                        <div class="form-group">
                            <label for="driverPhone">رقم الهاتف</label>
                            <input type="tel" id="driverPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="driverNationality">الجنسية</label>
                            <input type="text" id="driverNationality">
                        </div>
                        <div class="form-group">
                            <label for="driverAddress">العنوان</label>
                            <input type="text" id="driverAddress">
                        </div>
                    </div>
                </div>

                <!-- تفاصيل العقد -->
                <div class="form-section">
                    <h3 class="section-title">تفاصيل العقد</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="assignedCar">السيارة المخصصة</label>
                            <select id="assignedCar" onchange="updateCarRegistrationExpiry()">
                                <option value="">اختر السيارة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dailyRent">الأجرة اليومية (د.ك)</label>
                            <input type="number" id="dailyRent" step="0.001" required>
                        </div>
                        <div class="form-group">
                            <label for="contractDuration">مدة العقد (بالأشهر)</label>
                            <select id="contractDuration" onchange="calculateContractEndDate()">
                                <option value="">اختر المدة</option>
                                <option value="1">شهر واحد</option>
                                <option value="3">3 أشهر</option>
                                <option value="6">6 أشهر</option>
                                <option value="12">سنة واحدة</option>
                                <option value="24">سنتان</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="contractStartDate">تاريخ بداية العقد</label>
                            <input type="date" id="contractStartDate" onchange="calculateContractEndDate()">
                        </div>
                        <div class="form-group">
                            <label for="contractEndDate">تاريخ نهاية العقد</label>
                            <input type="date" id="contractEndDate" readonly>
                        </div>
                    </div>
                </div>

                <!-- تواريخ انتهاء الوثائق -->
                <div class="form-section">
                    <h3 class="section-title">تواريخ انتهاء الوثائق</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="carRegistrationExpiry">انتهاء دفتر السيارة</label>
                            <input type="date" id="carRegistrationExpiry" readonly>
                        </div>
                        <div class="form-group">
                            <label for="residencyExpiry">انتهاء الإقامة</label>
                            <input type="date" id="residencyExpiry">
                        </div>
                        <div class="form-group">
                            <label for="licenseExpiry">انتهاء الرخصة</label>
                            <input type="date" id="licenseExpiry">
                        </div>
                        <div class="form-group">
                            <label for="permitExpiry">انتهاء التصريح</label>
                            <input type="date" id="permitExpiry">
                        </div>
                        <div class="form-group">
                            <label for="passportExpiry">انتهاء جواز السفر</label>
                            <input type="date" id="passportExpiry">
                        </div>
                    </div>
                </div>

                <!-- الديون والملاحظات -->
                <div class="form-section">
                    <h3 class="section-title">الديون والملاحظات</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="oldDebts">ديون قديمة (د.ك)</label>
                            <input type="number" id="oldDebts" step="0.001" value="0">
                        </div>
                        <div class="form-group full-width">
                            <label for="driverNotes">ملاحظة</label>
                            <textarea id="driverNotes" rows="3" placeholder="ملاحظات إضافية..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeModal()">إلغاء</button>
                    <button type="submit" class="save-btn">حفظ السائق</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة تعديل سائق -->
    <div id="editDriverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">تعديل بيانات السائق</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            
            <form id="editDriverForm">
                <input type="hidden" id="editDriverId">
                <!-- البيانات الشخصية -->
                <div class="form-section">
                    <h3 class="section-title">البيانات الشخصية</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editDriverName">اسم السائق</label>
                            <input type="text" id="editDriverName" required>
                        </div>
                        <div class="form-group">
                            <label for="editDriverPhone">رقم الهاتف</label>
                            <input type="tel" id="editDriverPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="editDriverNationality">الجنسية</label>
                            <input type="text" id="editDriverNationality">
                        </div>
                        <div class="form-group">
                            <label for="editDriverAddress">العنوان</label>
                            <input type="text" id="editDriverAddress">
                        </div>
                    </div>
                </div>

                <!-- تفاصيل العقد -->
                <div class="form-section">
                    <h3 class="section-title">تفاصيل العقد</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editAssignedCar">السيارة المخصصة</label>
                            <select id="editAssignedCar" onchange="updateEditCarRegistrationExpiry()">
                                <option value="">اختر السيارة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDailyRent">الأجرة اليومية (د.ك)</label>
                            <input type="number" id="editDailyRent" step="0.001" required>
                        </div>
                        <div class="form-group">
                            <label for="editContractDuration">مدة العقد (بالأشهر)</label>
                            <select id="editContractDuration" onchange="calculateEditContractEndDate()">
                                <option value="">اختر المدة</option>
                                <option value="1">شهر واحد</option>
                                <option value="3">3 أشهر</option>
                                <option value="6">6 أشهر</option>
                                <option value="12">سنة واحدة</option>
                                <option value="24">سنتان</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editContractStartDate">تاريخ بداية العقد</label>
                            <input type="date" id="editContractStartDate" onchange="calculateEditContractEndDate()">
                        </div>
                        <div class="form-group">
                            <label for="editContractEndDate">تاريخ نهاية العقد</label>
                            <input type="date" id="editContractEndDate" readonly>
                        </div>
                    </div>
                </div>

                <!-- تواريخ انتهاء الوثائق -->
                <div class="form-section">
                    <h3 class="section-title">تواريخ انتهاء الوثائق</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editCarRegistrationExpiry">انتهاء دفتر السيارة</label>
                            <input type="date" id="editCarRegistrationExpiry" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editResidencyExpiry">انتهاء الإقامة</label>
                            <input type="date" id="editResidencyExpiry">
                        </div>
                        <div class="form-group">
                            <label for="editLicenseExpiry">انتهاء الرخصة</label>
                            <input type="date" id="editLicenseExpiry">
                        </div>
                        <div class="form-group">
                            <label for="editPermitExpiry">انتهاء التصريح</label>
                            <input type="date" id="editPermitExpiry">
                        </div>
                        <div class="form-group">
                            <label for="editPassportExpiry">انتهاء جواز السفر</label>
                            <input type="date" id="editPassportExpiry">
                        </div>
                    </div>
                </div>

                <!-- الديون والملاحظات -->
                <div class="form-section">
                    <h3 class="section-title">الديون والملاحظات</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editOldDebts">ديون قديمة (د.ك)</label>
                            <input type="number" id="editOldDebts" step="0.001" value="0">
                        </div>
                        <div class="form-group full-width">
                            <label for="editDriverNotes">ملاحظة</label>
                            <textarea id="editDriverNotes" rows="3" placeholder="ملاحظات إضافية..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">إلغاء</button>
                    <button type="submit" class="save-btn">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8Q9CYIWXPmTdiz3vPiLlPYFxiJu0vE_g",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.firebasestorage.app",
            messagingSenderId: "590210877687",
            appId: "1:590210877687:web:7b7b7b7b7b7b7b7b7b7b7b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allDrivers = [];
        let allCars = [];
        let editingDriverId = null;

        // Authentication check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadDrivers();
                loadCars();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Load drivers from Firestore
        async function loadDrivers() {
            try {
                const driversSnapshot = await getDocs(collection(db, 'drivers'));
                allDrivers = [];

                driversSnapshot.forEach((doc) => {
                    allDrivers.push({ id: doc.id, ...doc.data() });
                });

                displayDrivers(allDrivers);
            } catch (error) {
                console.error('خطأ في تحميل السائقين:', error);
                document.getElementById('driversGrid').innerHTML = '<div class="loading">خطأ في تحميل السائقين</div>';
            }
        }

        // Load cars for assignment dropdown
        async function loadCars() {
            try {
                const carsSnapshot = await getDocs(collection(db, 'cars'));
                allCars = [];

                carsSnapshot.forEach((doc) => {
                    allCars.push({ id: doc.id, ...doc.data() });
                });

                updateCarDropdowns();
            } catch (error) {
                console.error('خطأ في تحميل السيارات:', error);
            }
        }

        // Update car dropdowns
        function updateCarDropdowns() {
            const carSelects = [document.getElementById('assignedCar'), document.getElementById('editAssignedCar')];
            
            carSelects.forEach(carSelect => {
                if (carSelect) {
                    carSelect.innerHTML = '<option value="">اختر السيارة</option>';

                    // Get available cars (not assigned to other drivers)
                    const assignedCarIds = allDrivers.map(driver => driver.assignedCar).filter(Boolean);
                    const availableCars = allCars.filter(car => !assignedCarIds.includes(car.id));

                    availableCars.forEach(car => {
                        const option = document.createElement('option');
                        option.value = car.id;
                        option.textContent = `${car.plateNumber || 'غير محدد'} - ${car.model || 'غير محدد'}`;
                        carSelect.appendChild(option);
                    });
                }
            });
        }

        // Display drivers
        function displayDrivers(drivers) {
            const driversGrid = document.getElementById('driversGrid');
            
            if (drivers.length === 0) {
                driversGrid.innerHTML = '<div class="loading">لا توجد سائقين مسجلين</div>';
                return;
            }

            driversGrid.innerHTML = drivers.map(driver => {
                // Find assigned car
                const assignedCar = allCars.find(car => car.id === driver.assignedCar);
                const carInfo = assignedCar ? `${assignedCar.plateNumber || 'غير محدد'} - ${assignedCar.model || 'غير محدد'}` : 'لا توجد سيارة مخصصة';

                return `
                    <div class="driver-card">
                        <div class="driver-header">
                            <div class="driver-name">${driver.name || 'غير محدد'}</div>
                            <div class="driver-phone">${driver.phone || 'غير محدد'}</div>
                        </div>
                        <div class="driver-body">
                            <div class="driver-info">
                                <div class="info-row">
                                    <span class="info-label">السيارة المخصصة:</span>
                                    <span class="info-value">${carInfo}</span>
                                </div>
                                ${driver.dailyRent ? `
                                    <div class="info-row">
                                        <span class="info-label">الأجرة اليومية:</span>
                                        <span class="info-value">${driver.dailyRent} د.ك</span>
                                    </div>
                                ` : ''}
                                ${driver.nationality ? `
                                    <div class="info-row">
                                        <span class="info-label">الجنسية:</span>
                                        <span class="info-value">${driver.nationality}</span>
                                    </div>
                                ` : ''}
                                ${driver.contractStartDate ? `
                                    <div class="info-row">
                                        <span class="info-label">بداية العقد:</span>
                                        <span class="info-value">${formatDate(driver.contractStartDate)}</span>
                                    </div>
                                ` : ''}
                                ${driver.contractEndDate ? `
                                    <div class="info-row">
                                        <span class="info-label">نهاية العقد:</span>
                                        <span class="info-value">${formatDate(driver.contractEndDate)}</span>
                                    </div>
                                ` : ''}
                                ${driver.oldDebts && driver.oldDebts > 0 ? `
                                    <div class="info-row">
                                        <span class="info-label">ديون قديمة:</span>
                                        <span class="info-value debt-amount">${driver.oldDebts} د.ك</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${driver.notes ? `
                                <div class="driver-notes">
                                    <strong>ملاحظات:</strong> ${driver.notes}
                                </div>
                            ` : ''}
                            
                            <div class="driver-actions">
                                <button class="action-btn edit-btn" onclick="editDriver('${driver.id}')">تعديل</button>
                                <button class="action-btn delete-btn" onclick="deleteDriver('${driver.id}')">حذف</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format date
        function formatDate(dateValue) {
            if (!dateValue) return '';
            
            let date;
            if (dateValue.toDate) {
                // Firestore Timestamp
                date = dateValue.toDate();
            } else if (typeof dateValue === 'string') {
                date = new Date(dateValue);
            } else {
                date = dateValue;
            }
            
            return date.toLocaleDateString('en-GB');
        }

        // Filter drivers
        window.filterDrivers = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredDrivers = allDrivers.filter(driver => 
                (driver.name && driver.name.toLowerCase().includes(searchTerm)) ||
                (driver.phone && driver.phone.toLowerCase().includes(searchTerm)) ||
                (driver.nationality && driver.nationality.toLowerCase().includes(searchTerm))
            );
            
            displayDrivers(filteredDrivers);
        };

        // Open add modal
        window.openAddModal = function() {
            editingDriverId = null;
            document.querySelector('#addDriverModal .modal-title').textContent = 'إضافة سائق جديد';
            document.getElementById('driverForm').reset();
            document.getElementById('oldDebts').value = '0';
            updateCarDropdowns();
            document.getElementById('addDriverModal').style.display = 'block';
        };

        // Close modal
        window.closeModal = function() {
            document.getElementById('addDriverModal').style.display = 'none';
            editingDriverId = null;
        };

        // Close edit modal
        window.closeEditModal = function() {
            document.getElementById('editDriverModal').style.display = 'none';
            editingDriverId = null;
        };

        // Edit driver
        window.editDriver = function(driverId) {
            const driver = allDrivers.find(d => d.id === driverId);
            if (!driver) return;

            editingDriverId = driverId;
            
            // Fill form fields
            document.getElementById('editDriverId').value = driverId;
            document.getElementById('editDriverName').value = driver.name || '';
            document.getElementById('editDriverPhone').value = driver.phone || '';
            document.getElementById('editDriverNationality').value = driver.nationality || '';
            document.getElementById('editDriverAddress').value = driver.address || '';
            document.getElementById('editDailyRent').value = driver.dailyRent || '';
            document.getElementById('editContractDuration').value = driver.contractDuration || '';
            document.getElementById('editOldDebts').value = driver.oldDebts || '0';
            document.getElementById('editDriverNotes').value = driver.notes || '';
            
            // Fill date fields
            if (driver.contractStartDate) {
                const startDate = driver.contractStartDate.toDate ? driver.contractStartDate.toDate() : new Date(driver.contractStartDate);
                document.getElementById('editContractStartDate').value = startDate.toISOString().split('T')[0];
            }
            if (driver.contractEndDate) {
                const endDate = driver.contractEndDate.toDate ? driver.contractEndDate.toDate() : new Date(driver.contractEndDate);
                document.getElementById('editContractEndDate').value = endDate.toISOString().split('T')[0];
            }
            if (driver.residencyExpiry) {
                const residencyDate = driver.residencyExpiry.toDate ? driver.residencyExpiry.toDate() : new Date(driver.residencyExpiry);
                document.getElementById('editResidencyExpiry').value = residencyDate.toISOString().split('T')[0];
            }
            if (driver.licenseExpiry) {
                const licenseDate = driver.licenseExpiry.toDate ? driver.licenseExpiry.toDate() : new Date(driver.licenseExpiry);
                document.getElementById('editLicenseExpiry').value = licenseDate.toISOString().split('T')[0];
            }
            if (driver.permitExpiry) {
                const permitDate = driver.permitExpiry.toDate ? driver.permitExpiry.toDate() : new Date(driver.permitExpiry);
                document.getElementById('editPermitExpiry').value = permitDate.toISOString().split('T')[0];
            }
            if (driver.passportExpiry) {
                const passportDate = driver.passportExpiry.toDate ? driver.passportExpiry.toDate() : new Date(driver.passportExpiry);
                document.getElementById('editPassportExpiry').value = passportDate.toISOString().split('T')[0];
            }

            updateCarDropdowns();
            if (driver.assignedCar) {
                document.getElementById('editAssignedCar').value = driver.assignedCar;
            }
            
            document.getElementById('editDriverModal').style.display = 'block';
        };

        // Delete driver
        window.deleteDriver = async function(driverId) {
            if (!confirm('هل أنت متأكد من حذف هذا السائق؟')) return;

            try {
                await deleteDoc(doc(db, 'drivers', driverId));
                loadDrivers();
                alert('تم حذف السائق بنجاح');
            } catch (error) {
                console.error('خطأ في حذف السائق:', error);
                alert('حدث خطأ في حذف السائق');
            }
        };

        // Calculate contract end date
        window.calculateContractEndDate = function() {
            const startDate = document.getElementById('contractStartDate').value;
            const duration = document.getElementById('contractDuration').value;
            
            if (startDate && duration) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setMonth(end.getMonth() + parseInt(duration));
                
                document.getElementById('contractEndDate').value = end.toISOString().split('T')[0];
            }
        };

        // Calculate edit contract end date
        window.calculateEditContractEndDate = function() {
            const startDate = document.getElementById('editContractStartDate').value;
            const duration = document.getElementById('editContractDuration').value;
            
            if (startDate && duration) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setMonth(end.getMonth() + parseInt(duration));
                
                document.getElementById('editContractEndDate').value = end.toISOString().split('T')[0];
            }
        };

        // Update car registration expiry
        window.updateCarRegistrationExpiry = function() {
            const carId = document.getElementById('assignedCar').value;
            const car = allCars.find(c => c.id === carId);
            
            if (car && car.registrationExpiry) {
                const expiry = car.registrationExpiry.toDate ? car.registrationExpiry.toDate() : new Date(car.registrationExpiry);
                document.getElementById('carRegistrationExpiry').value = expiry.toISOString().split('T')[0];
            } else {
                document.getElementById('carRegistrationExpiry').value = '';
            }
        };

        // Update edit car registration expiry
        window.updateEditCarRegistrationExpiry = function() {
            const carId = document.getElementById('editAssignedCar').value;
            const car = allCars.find(c => c.id === carId);
            
            if (car && car.registrationExpiry) {
                const expiry = car.registrationExpiry.toDate ? car.registrationExpiry.toDate() : new Date(car.registrationExpiry);
                document.getElementById('editCarRegistrationExpiry').value = expiry.toISOString().split('T')[0];
            } else {
                document.getElementById('editCarRegistrationExpiry').value = '';
            }
        };

        // Form submission for adding driver
        document.getElementById('driverForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const driverData = {
                name: document.getElementById('driverName').value,
                phone: document.getElementById('driverPhone').value,
                nationality: document.getElementById('driverNationality').value,
                address: document.getElementById('driverAddress').value,
                assignedCar: document.getElementById('assignedCar').value || null,
                dailyRent: parseFloat(document.getElementById('dailyRent').value) || 0,
                contractDuration: parseInt(document.getElementById('contractDuration').value) || null,
                contractStartDate: document.getElementById('contractStartDate').value ? 
                    new Date(document.getElementById('contractStartDate').value) : null,
                contractEndDate: document.getElementById('contractEndDate').value ? 
                    new Date(document.getElementById('contractEndDate').value) : null,
                residencyExpiry: document.getElementById('residencyExpiry').value ? 
                    new Date(document.getElementById('residencyExpiry').value) : null,
                licenseExpiry: document.getElementById('licenseExpiry').value ? 
                    new Date(document.getElementById('licenseExpiry').value) : null,
                permitExpiry: document.getElementById('permitExpiry').value ? 
                    new Date(document.getElementById('permitExpiry').value) : null,
                passportExpiry: document.getElementById('passportExpiry').value ? 
                    new Date(document.getElementById('passportExpiry').value) : null,
                oldDebts: parseFloat(document.getElementById('oldDebts').value) || 0,
                notes: document.getElementById('driverNotes').value,
                createdAt: new Date(),
                createdBy: currentUser.name || currentUser.email,
                updatedAt: new Date(),
                updatedBy: currentUser.name || currentUser.email
            };

            try {
                await addDoc(collection(db, 'drivers'), driverData);
                alert('تم إضافة السائق بنجاح');
                closeModal();
                loadDrivers();
                loadCars(); // Reload cars to update dropdown
            } catch (error) {
                console.error('خطأ في حفظ السائق:', error);
                alert('حدث خطأ في حفظ السائق');
            }
        });

        // Form submission for editing driver
        document.getElementById('editDriverForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const driverData = {
                name: document.getElementById('editDriverName').value,
                phone: document.getElementById('editDriverPhone').value,
                nationality: document.getElementById('editDriverNationality').value,
                address: document.getElementById('editDriverAddress').value,
                assignedCar: document.getElementById('editAssignedCar').value || null,
                dailyRent: parseFloat(document.getElementById('editDailyRent').value) || 0,
                contractDuration: parseInt(document.getElementById('editContractDuration').value) || null,
                contractStartDate: document.getElementById('editContractStartDate').value ? 
                    new Date(document.getElementById('editContractStartDate').value) : null,
                contractEndDate: document.getElementById('editContractEndDate').value ? 
                    new Date(document.getElementById('editContractEndDate').value) : null,
                residencyExpiry: document.getElementById('editResidencyExpiry').value ? 
                    new Date(document.getElementById('editResidencyExpiry').value) : null,
                licenseExpiry: document.getElementById('editLicenseExpiry').value ? 
                    new Date(document.getElementById('editLicenseExpiry').value) : null,
                permitExpiry: document.getElementById('editPermitExpiry').value ? 
                    new Date(document.getElementById('editPermitExpiry').value) : null,
                passportExpiry: document.getElementById('editPassportExpiry').value ? 
                    new Date(document.getElementById('editPassportExpiry').value) : null,
                oldDebts: parseFloat(document.getElementById('editOldDebts').value) || 0,
                notes: document.getElementById('editDriverNotes').value,
                updatedAt: new Date(),
                updatedBy: currentUser.name || currentUser.email
            };

            try {
                await updateDoc(doc(db, 'drivers', editingDriverId), driverData);
                alert('تم تحديث بيانات السائق بنجاح');
                closeEditModal();
                loadDrivers();
                loadCars(); // Reload cars to update dropdown
            } catch (error) {
                console.error('خطأ في تحديث السائق:', error);
                alert('حدث خطأ في تحديث السائق');
            }
        });

        // Logout function
        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('خطأ في تسجيل الخروج:', error);
            }
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addDriverModal');
            const editModal = document.getElementById('editDriverModal');
            if (event.target === addModal) {
                closeModal();
            }
            if (event.target === editModal) {
                closeEditModal();
            }
        };
    </script>
</body>
</html>

