<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§ÙƒØ³ÙŠ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .driver-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .driver-info h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .driver-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: bold;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        .payments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .payment-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-top: 4px solid;
        }

        .payment-card.daily { border-top-color: #4CAF50; }
        .payment-card.old-debt { border-top-color: #2196F3; }
        .payment-card.violations { border-top-color: #FF9800; }
        .payment-card.residency { border-top-color: #9C27B0; }
        .payment-card.salary-fees { border-top-color: #607D8B; }

        .payment-card h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-payment {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-daily { background: #4CAF50; color: white; }
        .btn-old-debt { background: #2196F3; color: white; }
        .btn-violations { background: #FF9800; color: white; }
        .btn-residency { background: #9C27B0; color: white; }
        .btn-salary-fees { background: #607D8B; color: white; }

        .btn-payment:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .payment-history {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .payment-history h3 {
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .history-table th,
        .history-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .history-table tr:hover {
            background: #f5f5f5;
        }

        .amount-positive { color: #4CAF50; font-weight: bold; }
        .amount-negative { color: #f44336; font-weight: bold; }

        .error-message {
            background: #f44336;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: white;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .payments-grid {
                grid-template-columns: 1fr;
            }
            
            .driver-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ’° Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
        <div class="header-buttons">
            <a href="drivers-overview-fixed.html" class="btn btn-secondary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</a>
        </div>
    </div>

    <div class="container">
        <div id="loadingMessage" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚...</div>
        
        <div id="errorMessage" class="error-message" style="display: none;">
            <h3>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
            <p id="errorText">Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>
            <a href="drivers-overview-fixed.html" class="btn btn-secondary" style="margin-top: 1rem;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</a>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Driver Info -->
            <div class="driver-info">
                <h2 id="driverName">Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
                <div class="driver-details">
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:</span>
                        <span class="detail-value" id="dailyWage">0 Ø¯.Ùƒ</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯:</span>
                        <span class="detail-value" id="contractStart">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø³Ø¯Ø§Ø¯:</span>
                        <span class="detail-value" id="lastPayment">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:</span>
                        <span class="detail-value amount-negative" id="violations">0 Ø¯.Ùƒ</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©:</span>
                        <span class="detail-value amount-negative" id="residencyFees">0 Ø¯.Ùƒ</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø¯ÙŠÙˆÙ† Ù‚Ø¯ÙŠÙ…Ø©:</span>
                        <span class="detail-value amount-negative" id="oldDebts">0 Ø¯.Ùƒ</span>
                    </div>
                </div>
            </div>

            <!-- Payment Forms -->
            <div class="payments-grid">
                <!-- Daily Payment -->
                <div class="payment-card daily">
                    <h3>ğŸ’µ Ø¯ÙØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                    <form id="dailyPaymentForm">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ùƒ)</label>
                            <input type="number" step="0.001" id="dailyAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="dailyDate" required>
                        </div>
                        <div class="form-group">
                            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea id="dailyNotes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-daily">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© ÙŠÙˆÙ…ÙŠØ©</button>
                    </form>
                </div>

                <!-- Old Debt Payment -->
                <div class="payment-card old-debt">
                    <h3>ğŸ“‹ Ø¯ÙØ¹ Ø¯ÙŠÙ† Ù‚Ø¯ÙŠÙ…</h3>
                    <form id="oldDebtForm">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ùƒ)</label>
                            <input type="number" step="0.001" id="oldDebtAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="oldDebtDate" required>
                        </div>
                        <div class="form-group">
                            <label>ÙˆØµÙ Ø§Ù„Ø¯ÙŠÙ†</label>
                            <textarea id="oldDebtDescription" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-old-debt">ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ† Ù‚Ø¯ÙŠÙ…</button>
                    </form>
                </div>

                <!-- Violations Management -->
                <div class="payment-card violations">
                    <h3>ğŸš« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                        <select id="violationType" onchange="toggleViolationForm()">
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</option>
                            <option value="pay">Ø¯ÙØ¹ Ù…Ø®Ø§Ù„ÙØ© (Ø§Ù„Ø´Ø±ÙƒØ© ØªØ¯ÙØ¹)</option>
                            <option value="collect">ØªØ­ØµÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ© (Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙŠØ³Ø¯Ø¯)</option>
                        </select>
                    </div>
                    
                    <form id="violationPayForm" style="display: none;">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ùƒ)</label>
                            <input type="number" step="0.001" id="violationPayAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="violationPayDate" required>
                        </div>
                        <div class="form-group">
                            <label>ÙˆØµÙ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</label>
                            <textarea id="violationDescription" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-violations">Ø¯ÙØ¹ Ù…Ø®Ø§Ù„ÙØ©</button>
                    </form>

                    <form id="violationCollectForm" style="display: none;">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ùƒ)</label>
                            <input type="number" step="0.001" id="violationCollectAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="violationCollectDate" required>
                        </div>
                        <div class="form-group">
                            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea id="violationCollectNotes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-violations">ØªØ­ØµÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©</button>
                    </form>
                </div>

                <!-- Residency Management -->
                <div class="payment-card residency">
                    <h3>ğŸ  Ø¥Ø¯Ø§Ø±Ø© Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</h3>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                        <select id="residencyType" onchange="toggleResidencyForm()">
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</option>
                            <option value="pay">Ø¯ÙØ¹ Ø±Ø³ÙˆÙ… Ø¥Ù‚Ø§Ù…Ø© (Ø§Ù„Ø´Ø±ÙƒØ© ØªØ¯ÙØ¹)</option>
                            <option value="collect">ØªØ­ØµÙŠÙ„ Ø±Ø³ÙˆÙ… Ø¥Ù‚Ø§Ù…Ø© (Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙŠØ³Ø¯Ø¯)</option>
                        </select>
                    </div>
                    
                    <form id="residencyPayForm" style="display: none;">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ùƒ)</label>
                            <input type="number" step="0.001" id="residencyPayAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="residencyPayDate" required>
                        </div>
                        <div class="form-group">
                            <label>ÙˆØµÙ Ø§Ù„Ø±Ø³ÙˆÙ…</label>
                            <textarea id="residencyDescription" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-residency">Ø¯ÙØ¹ Ø±Ø³ÙˆÙ… Ø¥Ù‚Ø§Ù…Ø©</button>
                    </form>

                    <form id="residencyCollectForm" style="display: none;">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ùƒ)</label>
                            <input type="number" step="0.001" id="residencyCollectAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="residencyCollectDate" required>
                        </div>
                        <div class="form-group">
                            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea id="residencyCollectNotes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-residency">ØªØ­ØµÙŠÙ„ Ø±Ø³ÙˆÙ… Ø¥Ù‚Ø§Ù…Ø©</button>
                    </form>
                </div>

                <!-- Salary Fees Collection -->
                <div class="payment-card salary-fees">
                    <h3>ğŸ’¼ ØªØ­ØµÙŠÙ„ Ø±Ø³ÙˆÙ… Ø§Ù„Ø±ÙˆØ§ØªØ¨</h3>
                    <form id="salaryFeesForm">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ùƒ)</label>
                            <input type="number" step="0.001" id="salaryFeesAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="salaryFeesDate" required>
                        </div>
                        <div class="form-group">
                            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea id="salaryFeesNotes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-payment btn-salary-fees">ØªØ­ØµÙŠÙ„ Ø±Ø³ÙˆÙ… Ø±ÙˆØ§ØªØ¨</button>
                    </form>
                </div>
            </div>

            <!-- Payment History -->
            <div class="payment-history">
                <h3>ğŸ“Š ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø§Øª</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„ÙˆØµÙ</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryBody">
                        <tr>
                            <td>18/06/2025</td>
                            <td>ØªØ­ØµÙŠÙ„ Ø£Ø¬Ø±Ø© ÙŠÙˆÙ…ÙŠØ©</td>
                            <td class="amount-positive">7.000 Ø¯.Ùƒ</td>
                            <td>Ø¯ÙØ¹Ø© ÙŠÙˆÙ…ÙŠØ©</td>
                            <td>Ø¥ÙŠØ±Ø§Ø¯</td>
                        </tr>
                        <tr>
                            <td>17/06/2025</td>
                            <td>Ù…Ø®Ø§Ù„ÙØ©</td>
                            <td class="amount-negative">25.000 Ø¯.Ùƒ</td>
                            <td>Ù…Ø®Ø§Ù„ÙØ© Ø³Ø±Ø¹Ø©</td>
                            <td>Ø¯ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚</td>
                        </tr>
                        <tr>
                            <td>15/06/2025</td>
                            <td>Ø±Ø³ÙˆÙ… Ø¥Ù‚Ø§Ù…Ø©</td>
                            <td class="amount-negative">50.000 Ø¯.Ùƒ</td>
                            <td>ØªØ¬Ø¯ÙŠØ¯ Ø¥Ù‚Ø§Ù…Ø©</td>
                            <td>Ø¯ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, addDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration - Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
        const firebaseConfig = {
            apiKey: "AIzaSyB8Q9CYIWXPmTdiz3vPiLlPYFxiJu0vE_g",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.firebasestorage.app",
            messagingSenderId: "720874424166",
            appId: "1:720874424166:web:25f9c6d126e792b2e5eaa7",
            measurementId: "G-GY8820W410"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentDriver = null;

        // Load driver data
        async function loadDriverData() {
            try {
                // Get driver data from localStorage
                const driverData = localStorage.getItem('selectedDriver');
                if (!driverData) {
                    showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚');
                    return;
                }

                const driver = JSON.parse(driverData);
                console.log('Driver from localStorage:', driver);

                // Verify driver exists in Firebase
                const driverDoc = await getDoc(doc(db, 'drivers', driver.id));
                if (!driverDoc.exists()) {
                    showError('Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    return;
                }

                currentDriver = { id: driver.id, ...driverDoc.data() };
                console.log('Driver from Firebase:', currentDriver);

                displayDriverInfo();
                setupForms();
                hideLoading();

            } catch (error) {
                console.error('Error loading driver:', error);
                showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚: ' + error.message);
            }
        }

        // Display driver information
        function displayDriverInfo() {
            document.getElementById('driverName').textContent = `Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚: ${currentDriver.name}`;
            document.getElementById('dailyWage').textContent = `${currentDriver.dailyWage || 0} Ø¯.Ùƒ`;
            document.getElementById('contractStart').textContent = formatDate(currentDriver.contractStartDate);
            document.getElementById('lastPayment').textContent = formatDate(currentDriver.lastPaymentDate);
            document.getElementById('violations').textContent = `${currentDriver.violations || 0} Ø¯.Ùƒ`;
            document.getElementById('residencyFees').textContent = `${currentDriver.residencyFees || 0} Ø¯.Ùƒ`;
            document.getElementById('oldDebts').textContent = `${currentDriver.oldDebts || 0} Ø¯.Ùƒ`;
        }

        // Setup form default values
        function setupForms() {
            const today = new Date().toISOString().split('T')[0];
            
            // Set today's date for all date inputs
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });

            // Set daily wage amount
            document.getElementById('dailyAmount').value = currentDriver.dailyWage || 0;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-SA');
            } catch {
                return dateString;
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // Toggle violation forms
        window.toggleViolationForm = function() {
            const type = document.getElementById('violationType').value;
            document.getElementById('violationPayForm').style.display = type === 'pay' ? 'block' : 'none';
            document.getElementById('violationCollectForm').style.display = type === 'collect' ? 'block' : 'none';
        }

        // Toggle residency forms
        window.toggleResidencyForm = function() {
            const type = document.getElementById('residencyType').value;
            document.getElementById('residencyPayForm').style.display = type === 'pay' ? 'block' : 'none';
            document.getElementById('residencyCollectForm').style.display = type === 'collect' ? 'block' : 'none';
        }

        // Form submission handlers
        document.getElementById('dailyPaymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('dailyAmount').value);
            const date = document.getElementById('dailyDate').value;
            const notes = document.getElementById('dailyNotes').value;

            await addPayment('daily_collection', amount, date, notes, 'revenue');
        });

        document.getElementById('oldDebtForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('oldDebtAmount').value);
            const date = document.getElementById('oldDebtDate').value;
            const description = document.getElementById('oldDebtDescription').value;

            await addPayment('old_debt', amount, date, description, 'revenue');
        });

        // Add payment function
        async function addPayment(type, amount, date, description, category) {
            try {
                // Add to revenues/expenses collection
                const paymentData = {
                    driverId: currentDriver.id,
                    driverName: currentDriver.name,
                    type: type,
                    amount: amount,
                    date: date,
                    description: description,
                    category: category,
                    createdAt: new Date().toISOString()
                };

                const collectionName = category === 'revenue' ? 'revenues' : 'expenses';
                await addDoc(collection(db, collectionName), paymentData);

                // Update driver data if needed
                if (type === 'daily_collection') {
                    await updateDoc(doc(db, 'drivers', currentDriver.id), {
                        lastPaymentDate: date,
                        paidUntilDate: date
                    });
                }

                alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                
                // Reload driver data
                await loadDriverData();

            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©: ' + error.message);
            }
        }

        // Load data on page load
        loadDriverData();
    </script>
</body>
</html>

